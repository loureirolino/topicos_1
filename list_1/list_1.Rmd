---
title: |
  ![](www/logo-UnB.png){width=75%}  <br> </br>
  Lista 1: Computação eficiente (dados em memória)
subtitle: "Computação em Estatística para dados e cálculos massivos"
author: "<b>Autor:</b> Lucas Loureiro Lino da Costa"
affiliation: "Universidade de Brasília"
date: "`r Sys.setlocale('LC_TIME', 'pt_BR'); Sys.setlocale('LC_ALL','pt_BR'); format(Sys.Date(), '%d de %B de %Y')`"
tags: [estatística, computação]
output:
  rmdformats::readthedown:
    theme: 
      version: 3
    code_folding: hide
    highlight: tango
    css: "style.css"
    #number_sections: true
    # toc_float:
    #   collapsed: false
    #   smooth_scroll: false
    df_print: kable
    fig_width: 7
    fig_height: 6
    self_contained: true
    #thumbnails: true
    lightbox: true
link-citations: yes
always_allow_html: true
---

<!-- YAML acima!!!-->


<!-- knitr config-->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Configurando sistema para a língua portuguesa pt-BR
Sys.setlocale("LC_TIME", "pt_BR")
Sys.setlocale("LC_ALL","pt_BR")

# Não utilização de notação científica:
options(scipen = 999)
```

# Informações Gerais

1. Os códigos se encontram 'escondidos' e podem ser acessados ao apertar o botão **Code** na página.
2. O comando original das questões podem ser encontradas no [github](https://github.com/loureirolino/topicos_1/blob/main/assignments/Lista_1.pdf).
3. As pastas com arquivos baixados foram configuradas para não serem integradas ao github, para evitar subir um volume desnecessário de arquivos.

# Questões

## Questão 1: leitura eficiente de dados

### 1.a)
```{r 1.a, results='asis'}
# CUIDADO AO RODAR ESSE CHUNK, DADOS MASSIVOS!!!!

# checando se o diretório existe e se necessário criá-lo
dir_name = 'dados'
if (file.exists(dir_name) == FALSE) {
  dir.create(dir_name)
  } else {
    invisible()
}

# baixando todos os arquivos dentro da URL base (scrap)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(rvest)

base_url = read_html('https://opendatasus.saude.gov.br/dataset/covid-19-vacinacao/resource/5093679f-12c3-4d6b-b7bd-07694de54173?inner_span=True')

entries = base_url %>%
  html_nodes(xpath = '//*[@id="content"]') %>%
  html_nodes('ul') %>%
  html_nodes('a') %>% 
  html_attr('href')
entries = entries[grep(pattern= '.csv', x = entries)]

options(timeout=999999) # essa linha é um workaround para o timeout do download

for (i in 1:length(entries)) {
  if (file.exists(paste0(dir_name, '/', 'file_', i,'.csv')) == FALSE) {
    download.file(entries[i],
                  destfile = paste0(dir_name, '/', 'file_', i, '.csv'),
                  mode='wb',
                  quiet = TRUE,
                  cacheOK=FALSE,
                  method="libcurl",
                  url.method="libcurl")
  } else {
    invisible()
  }
}

```

### 1.b)
```{r 1.b}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(vroom, tidyverse)

# carregando o arquivo previamente baixado
data_1 = vroom(sort(list.files(dir_name, full.names = TRUE))[1],
               locale = locale("br", encoding = "latin1"),
               num_threads = 3)
spec(data_1)

# # # carregando o arquivo diretamente da internet
# data_1 =vroom(entries[1], locale = locale("br", encoding = "latin1"), num_threads = 3)
```


O arquivo contendo o dicionário das variáveis pode ser encontrado no link abaixo:  
`r xfun::embed_file("dicionario-de-dados-vacinacao.pdf")`:


**Descrição do Banco de dados**

Variável | Descrição 
---|------------------------------------------------------------------------------
document_id  | ;
paciente_id  | ;
paciente_dataNascimento  | ;
paciente_enumSexoBiologico  | ;
paciente_racaCor_codigo  | ;
paciente_racaCor_valor  | ;
paciente_endereco_coIbgeMunicipio  | ;
paciente_endereco_coPais  | ;
paciente_endereco_nmMunicipio  | ;
paciente_endereco_nmPais | Gráficos (1);
paciente_endereco_uf | ;
paciente_endereco_cep | ;
paciente_nacionalidade_enumNacionalidade | ;
estabelecimento_valor | ;
estabelecimento_razaoSocial | ;
estalecimento_noFantasia | ;
estabelecimento_municipio_codigo | ;
estabelecimento_municipio_nome | ;
estabelecimento_uf | ;
vacina_grupoAtendimento_codigo | ;
vacina_grupoAtendimento_nome | ;
vacina_categoria_codigo | ;
vacina_categoria_nome | ;
vacina_lote | ;
vacina_fabricante_nome | ;
vacina_fabricante_referencia | ;
vacina_dataAplicacao | ;
vacina_descricao_dose | ;
vacina_codigo | ;
vacina_nome | ;
sistema_origem | ;



### 1.c)
```{r 1.c, eval=FALSE}
# Dimensão dos arquivos separados

count.fields((list.files(dir_name, full.names = TRUE)[1]), sep = ';')[[1]]
map(list.files(dir_name, full.names = TRUE)[1], count.fields, sep = ';')

# Dimensão dos arquivos unificados
sum(map(list.files(dir_name, full.names = TRUE), count.fields))
  
# Tamanho dos arquivos separados em MB (usando object.size caso tenhamos metadados junto os arquivos)
map(list.files(dir_name, full.names = TRUE), object.size)

# Tamanho dos arquivos unificados em MB (usando object.size caso tenhamos metadados junto os arquivos)
sum(map(list.files(dir_name, full.names = TRUE), object.size))
```

### 1.d)
```{r 1.d, eval=FALSE}
# usando o arquivo previamente baixado
data_1 = vroom(pipe(paste0('grep -w ASTRAZENECA', sort(list.files(dir_name, full.names = TRUE))[1])),
               locale = locale("br", encoding = "latin1"),
               num_threads = 3)

# # puxando da internet diretamente
# data_1 = vroom(pipe(paste0('grep -w ASTRAZENECA', entries[1])),
#                locale = locale("br", encoding = "latin1"),
#                num_threads = 3)
```

### 1.e)
```{r 1.e, eval=FALSE}
files = fs::dir_ls(glob = paste0(dir_name, '/', 'file_*csv'))
data_complete = vroom(files)
```

## Questão 2: manipulação de dados

### 2.a)
```{r 2.a}

```

### 2.b)
```{r 2.b}

```

### 2.c)
```{r 2.c}

```

### 2.d)
```{r 2.d}

```

```{r cleanup, include=FALSE}
rm(list = ls())
gc()
```

